From baa67c2bd6f07180921fd917f9aecc1e2082ac17 Mon Sep 17 00:00:00 2001
From: Milan Crha <mcrha@redhat.com>
Date: Tue, 3 Feb 2015 17:10:00 +0000
Subject: eds: Update to new EDS address book timeout API

Add a timeout parameter to handle the new EDS authentication process.
This means that folks no longer triggers authentication dialogues from
EDS, which will prevent them popping up unexpectedly (particularly from
GNOME Shell). However, it does mean that external processes using folks
which _do_ want to display authentication dialogues should manually
create an ECredentialsPrompter and use that to display the dialogues.

This bumps the EDS dependency to 3.13.90 unconditionally.

https://bugzilla.gnome.org/show_bug.cgi?id=743934
---
 NEWS                                       | 2 ++
 backends/eds/lib/edsf-persona-store.vala   | 2 +-
 configure.ac                               | 6 +++---
 tests/eds/helper-create-many-contacts.vala | 2 +-
 tests/eds/helper-delete-contacts.vala      | 2 +-
 tests/lib/eds/backend.vala                 | 2 +-
 6 files changed, 9 insertions(+), 7 deletions(-)

diff '--exclude=.git' -urN a/NEWS b/NEWS
--- a/NEWS	2015-01-19 12:37:46.000000000 -0500
+++ b/NEWS	2015-11-02 14:19:06.718638243 -0500
@@ -1,3 +1,16 @@
+Overview of changes from libfolks 0.10.1 to libfolks 0.11.0
+===========================================================
+
+Dependencies:
+ • evolution-data-server ≥ 3.13.90
+
+Major changes:
+
+Bugs fixed:
+ • Bug 743934 — FTBFS after EDS commit 884fb8d8
+
+API changes:
+
 Overview of changes from libfolks 0.10.0 to libfolks 0.10.1
 ===========================================================
 
diff '--exclude=.git' -urN a/backends/eds/lib/edsf-persona-store.vala b/backends/eds/lib/edsf-persona-store.vala
--- a/backends/eds/lib/edsf-persona-store.vala	2014-12-17 07:00:20.000000000 -0500
+++ b/backends/eds/lib/edsf-persona-store.vala	2015-11-02 14:15:04.974586555 -0500
@@ -760,7 +760,7 @@
                   this._source_registry_changed_cb);
 
               /* Connect and open the address book */
-              this._addressbook = yield E.BookClient.connect (this.source, null);
+              this._addressbook = yield E.BookClient.connect (this.source, 1, null);
 
               ((!) this._addressbook).notify["readonly"].connect (
                   this._address_book_notify_read_only_cb);
diff '--exclude=.git' -urN a/configure.ac b/configure.ac
--- a/configure.ac	2015-01-19 12:36:04.000000000 -0500
+++ b/configure.ac	2015-11-02 14:15:04.974586555 -0500
@@ -262,9 +262,9 @@
 VALA_REQUIRED=0.22.0.28-9090
 VALADOC_REQUIRED=0.3.1
 TRACKER_SPARQL_REQUIRED=0.15.2
-EBOOK_REQUIRED=3.8
-EBOOK_REQUIRED_FOR_BLUEZ=3.9.1
-EDATASERVER_REQUIRED=3.5.3.1
+EBOOK_REQUIRED=3.13.90
+EBOOK_REQUIRED_FOR_BLUEZ=3.13.90
+EDATASERVER_REQUIRED=3.13.90
 ZEITGEIST_REQUIRED=0.9.14
 GEE_REQUIRED=0.8.4
 
diff '--exclude=.git' -urN a/tests/eds/helper-create-many-contacts.vala b/tests/eds/helper-create-many-contacts.vala
--- a/tests/eds/helper-create-many-contacts.vala	2014-12-17 06:52:24.000000000 -0500
+++ b/tests/eds/helper-create-many-contacts.vala	2015-11-02 14:15:04.974586555 -0500
@@ -46,7 +46,7 @@
       var registry = new E.SourceRegistry.sync ();
       var source = registry.ref_source (uid);
       assert (source.uid == uid);
-      var book_client = E.BookClient.connect_sync (source);
+      var book_client = E.BookClient.connect_sync (source, 1);
       SList<E.Contact> contacts = null;
 
       var envvar = Environment.get_variable ("FOLKS_TESTS_REAL_VCARDS");
diff '--exclude=.git' -urN a/tests/eds/helper-delete-contacts.vala b/tests/eds/helper-delete-contacts.vala
--- a/tests/eds/helper-delete-contacts.vala	2014-12-17 06:52:24.000000000 -0500
+++ b/tests/eds/helper-delete-contacts.vala	2015-11-02 14:15:04.974586555 -0500
@@ -36,7 +36,7 @@
       var registry = new E.SourceRegistry.sync ();
       var source = registry.ref_source (uid);
       assert (source.uid == uid);
-      var book_client = E.BookClient.connect_sync (source);
+      var book_client = E.BookClient.connect_sync (source, 1);
 
       SList<string> uids;
       book_client.get_contacts_uids_sync (
diff '--exclude=.git' -urN a/tests/lib/eds/backend.vala b/tests/lib/eds/backend.vala
--- a/tests/lib/eds/backend.vala	2014-12-17 06:52:24.000000000 -0500
+++ b/tests/lib/eds/backend.vala	2015-11-02 14:15:04.974586555 -0500
@@ -108,7 +108,7 @@
           this._addressbook_name = name;
 
           this._prepare_source (source_is_default);
-          this._addressbook = BookClient.connect_sync (this._source, null);
+          this._addressbook = BookClient.connect_sync (this._source, 1, null);
           Environment.set_variable ("FOLKS_BACKEND_EDS_USE_ADDRESS_BOOKS",
                                     this._addressbook_name, true);
         }
-- 
cgit v0.11.2

